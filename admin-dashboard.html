<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Add Asset - AzAsset</title>

<!-- Tailwind CSS for UI styling -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<!-- Firebase configuration -->
<script src="firebase-config.js"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-[#0a0f1f] via-[#1a2337] to-[#0b1528] text-white pt-32">

<!-- ===================== HEADER ===================== -->
<header
  class="fixed top-0 left-0 w-full z-50 backdrop-blur-md bg-black/40
         border-b border-white/10 px-10 py-5 flex justify-between items-center">

  <!-- System name -->
  <h2 class="text-2xl font-bold">AzAsset</h2>

  <!-- Navigation -->
  <nav class="flex gap-4 items-center">
    <a href="admin-asset-table.html" class="hover:text-cyan-400">
      Assets Table
    </a>

    <button onclick="logout()"
      class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20">
      Logout
    </button>
  </nav>
</header>

<!-- ===================== ADD ASSET CARD ===================== -->
<div class="max-w-xl mx-auto bg-white/5 border border-white/10 rounded-xl p-6">

<h1 class="text-2xl font-bold mb-4">Add New Asset</h1>

<!-- ===================== MANUAL ADD FORM ===================== -->
<form id="addAssetForm" class="grid gap-3">

  <!-- Asset name -->
  <input id="name"
    class="px-4 py-2 rounded bg-white/10 border border-white/10"
    placeholder="Asset Name"
    required>

  <!-- Description -->
  <input id="description"
    class="px-4 py-2 rounded bg-white/10 border border-white/10"
    placeholder="Description">

  <!-- Purchase date -->
  <input id="purchaseDate"
    type="date"
    class="px-4 py-2 rounded bg-white/10 border border-white/10"
    required>

  <!-- Expiry date -->
  <input id="expiryDate"
    type="date"
    class="px-4 py-2 rounded bg-white/10 border border-white/10"
    required
    onchange="calcReminder()">

  <!-- Hidden reminder field -->
  <input id="remindBeforeDays" type="hidden">

  <!-- Department -->
  <select id="department"
    class="px-4 py-2 rounded bg-white/10 border border-white/10">
    <option>IT</option>
    <option>Finance</option>
    <option>HR</option>
    <option>Logistics</option>
  </select>

  <!-- Submit -->
  <button
    class="px-4 py-2 rounded bg-white text-black font-semibold">
    Save Asset
  </button>
</form>

<hr class="my-6 border-white/10">

<!-- ===================== CSV IMPORT ===================== -->

<!-- Hidden file input -->
<input type="file"
  id="csvInput"
  accept=".csv"
  hidden
  onchange="importCSV(event)">

<!-- Trigger CSV import -->
<button onclick="csvInput.click()"
  class="w-full px-4 py-2 rounded bg-cyan-500 text-black font-semibold">
  Import CSV
</button>

</div>

<!-- ===================== PAGE LOGIC ===================== -->
<script>

/**
 * Authentication guard
 * Redirects unauthenticated users to login page
 */
auth.onAuthStateChanged(u=>{
  if(!u) location.href='login.html';
});

/**
 * Logs admin out and redirects to login page
 */
function logout(){
  auth.signOut().then(()=>location.href='login.html');
}

/**
 * Calculates reminder days based on expiry date
 * Stores value in hidden input for Firestore
 */
function calcReminder(){
  const d = new Date(expiryDate.value);
  remindBeforeDays.value =
    Math.max(0, Math.ceil((d - new Date()) / 86400000));
}

/**
 * Handles manual asset submission
 * Saves asset directly as approved admin entry
 */
addAssetForm.onsubmit = async e => {
  e.preventDefault();

  const u = auth.currentUser;

  await db.collection('assets').add({
    name: name.value,
    description: description.value,
    purchaseDate: purchaseDate.value,
    expiryDate: expiryDate.value,
    remindBeforeDays: +remindBeforeDays.value,
    department: department.value,
    createdBy: u.email,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert('Asset added');
  addAssetForm.reset();
};

/**
 * Bulk CSV import handler
 * Reads CSV file and inserts each row as an asset
 *
 * Expected CSV format:
 * name,description,purchaseDate,expiryDate,department
 */
async function importCSV(e){
  const text = await e.target.files[0].text();

  // Skip CSV header row
  const rows = text.trim().split('\n').slice(1);

  for(const r of rows){
    const [n,d,p,ex,dep] = r.split(',');

    await db.collection('assets').add({
      name: n,
      description: d,
      purchaseDate: p,
      expiryDate: ex,
      remindBeforeDays:
        Math.ceil((new Date(ex) - new Date()) / 86400000),
      department: dep || 'Unassigned',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  alert('CSV imported');
}
</script>

</body>
</html>
