<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Request Asset - AzAsset</title>

<!-- Tailwind CSS for UI styling -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<!-- Firebase project configuration -->
<script src="firebase-config.js"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-[#0a0f1f] via-[#1a2337] to-[#0b1528] text-white overflow-x-hidden">

<!-- ===================== USER LAYOUT ===================== -->
<script>
/**
 * Loads shared user sidebar + top navigation
 * Ensures consistent layout across user pages
 */
async function loadUserLayout(){
  const res = await fetch("user-layout.html");
  const html = await res.text();
  document.body.insertAdjacentHTML("afterbegin", html);
}

/**
 * Toggles sidebar visibility (mobile-friendly)
 */
function toggleSidebar(){
  sidebar.classList.toggle("-translate-x-full");
  overlay.classList.toggle("hidden");
}

/**
 * Logs out the user and redirects to login page
 */
function logout(){
  auth.signOut().then(()=>location.href="login.html");
}

/* Load user layout immediately */
loadUserLayout();
</script>

<!-- ===================== PAGE CONTENT ===================== -->
<main class="pt-28 px-6 pb-16">

<div class="max-w-2xl mx-auto">

  <!-- Page title and description -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-cyan-200 mb-3">
      Request New Asset
    </h1>
    <p class="text-white/60">
      Submit an asset request for admin approval
    </p>
  </div>

  <!-- ===================== FORM CARD ===================== -->
  <div class="bg-white/5 border border-white/10 rounded-2xl p-8 shadow-xl">

    <!-- Asset request form -->
    <form id="addForm" class="space-y-5">

      <!-- Asset Name -->
      <div>
        <label class="block text-sm mb-2">Asset Name *</label>
        <input id="name" type="text" required
          class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20
                 focus:border-cyan-400 outline-none">
      </div>

      <!-- Asset Description -->
      <div>
        <label class="block text-sm mb-2">Description</label>
        <textarea id="description" rows="3"
          class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20
                 focus:border-cyan-400 outline-none"></textarea>
      </div>

      <!-- Purchase & Expiry Dates -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <!-- Purchase Date -->
        <div>
          <label class="block text-sm mb-2">Purchase Date *</label>
          <input id="purchaseDate" type="date" required
            class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20
                   focus:border-cyan-400 outline-none">
        </div>

        <!-- Expiry Date -->
        <div>
          <label class="block text-sm mb-2">Expiry Date *</label>
          <input id="expiryDate" type="date" required
            class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20
                   focus:border-cyan-400 outline-none">
        </div>

      </div>

      <!-- Information message -->
      <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4 text-sm text-cyan-200">
        Your request will remain <strong>Pending</strong> until approved by an admin.
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3 pt-4">
        <button type="submit"
          class="flex-1 py-3 rounded-lg bg-cyan-500 hover:bg-cyan-600
                 text-black font-semibold">
          Submit Request
        </button>

        <button type="reset"
          class="px-6 py-3 rounded-lg bg-white/10 hover:bg-white/20">
          Reset
        </button>
      </div>

    </form>
  </div>
</div>
</main>

<!-- ===================== PAGE LOGIC ===================== -->
<script>
/**
 * Stores the logged-in user's department
 * Used to assign asset requests correctly
 */
let currentUserDept = "";

/**
 * Authentication & approval check:
 * - User must be logged in
 * - User must be approved by admin
 * - Fetches user's department
 */
auth.onAuthStateChanged(async user => {
  if (!user) return location.href = "login.html";

  const doc = await db.collection("users").doc(user.uid).get();

  if (!doc.exists || doc.data().approved !== true) {
    alert("Your account is not approved by admin yet.");
    await auth.signOut();
    return location.href = "login.html";
  }

  currentUserDept = doc.data().department || "";
});

/**
 * Handles asset request submission
 */
document.getElementById("addForm").addEventListener("submit", async e => {
  e.preventDefault();

  const user = auth.currentUser;
  if (!user) return;

  // Retrieve input values
  const nameVal = name.value.trim();
  const descVal = description.value.trim();
  const purchaseVal = purchaseDate.value;
  const expiryVal = expiryDate.value;

  // Basic validation
  if (!nameVal || !purchaseVal || !expiryVal) {
    alert("Please complete all required fields.");
    return;
  }

  const purchase = new Date(purchaseVal);
  const expiry = new Date(expiryVal);

  // Ensure expiry date is after purchase date
  if (expiry <= purchase) {
    alert("Expiry date must be after purchase date.");
    return;
  }

  /**
   * Calculate number of days before expiry
   * Used later for expiry notifications
   */
  const remindBeforeDays = Math.ceil(
    (expiry - new Date()) / 86400000
  );

  try {
    // Save asset request into Firestore
    await db.collection("assets").add({
      name: nameVal,
      description: descVal,
      purchaseDate: purchaseVal,
      expiryDate: expiryVal,
      remindBeforeDays,
      department: currentUserDept,
      createdBy: user.email,
      userId: user.uid,
      status: "pending", // Admin must approve
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("âœ… Asset request submitted for admin approval.");
    e.target.reset();

  } catch (err) {
    console.error(err);
    alert("Failed to submit request.");
  }
});
</script>

</body>
</html>
