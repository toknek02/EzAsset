<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard - AzAsset</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Tailwind CSS for styling -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<!-- Firebase configuration -->
<script src="firebase-config.js"></script>
</head>

<body class="bg-gradient-to-br from-[#0a0f1f] via-[#1a2337] to-[#0b1528] min-h-screen text-white overflow-x-hidden">

<!-- ===================== ADMIN LAYOUT ===================== -->
<script>
/**
 * Loads the shared admin layout (sidebar + top bar)
 * Ensures consistent UI across all admin pages
 */
async function loadAdminLayout(){
  const res = await fetch("admin-layout.html");
  const html = await res.text();
  document.body.insertAdjacentHTML("afterbegin", html);
}

/**
 * Toggles sidebar visibility (mainly for mobile view)
 */
function toggleSidebar(){
  document.getElementById("sidebar").classList.toggle("-translate-x-full");
  document.getElementById("overlay").classList.toggle("hidden");
}

/**
 * Logs admin out and redirects to login page
 */
function logout(){
  auth.signOut().then(()=>location.href="login.html");
}

/* Load admin layout immediately */
loadAdminLayout();
</script>

<!-- ===================== PAGE CONTENT ===================== -->
<main class="pt-28 px-10 pb-10 max-w-[1600px] mx-auto">

<!-- ===================== STATISTICS CARDS ===================== -->
<div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-10">

  <!-- Total Assets -->
  <div class="p-6 rounded-2xl bg-green-500/20 border border-green-400/30">
    <p class="text-sm opacity-70">Total Assets</p>
    <h2 id="totalAssets" class="text-3xl font-bold mt-2">â€”</h2>
  </div>

  <!-- Expiring Soon -->
  <div class="p-6 rounded-2xl bg-yellow-500/20 border border-yellow-400/30">
    <p class="text-sm opacity-70">Expiring Soon</p>
    <h2 id="expiringAssets" class="text-3xl font-bold mt-2">â€”</h2>
  </div>

  <!-- Expired -->
  <div class="p-6 rounded-2xl bg-red-500/20 border border-red-400/30">
    <p class="text-sm opacity-70">Expired</p>
    <h2 id="expiredAssets" class="text-3xl font-bold mt-2">â€”</h2>
  </div>

  <!-- Departments (static value) -->
  <div class="p-6 rounded-2xl bg-blue-500/20 border border-blue-400/30">
    <p class="text-sm opacity-70">Departments</p>
    <h2 class="text-3xl font-bold mt-2">4</h2>
  </div>
</div>

<!-- ===================== EXPIRY NOTIFICATION SECTION ===================== -->
<div class="grid grid-cols-1 xl:grid-cols-[1.5fr_1.5fr] gap-8">

  <!-- LEFT: QUICK EXPIRY LIST -->
  <div class="bg-white/5 border border-white/10 rounded-xl p-8">
    <h2 class="text-xl font-semibold text-red-300 mb-4">
      âš  Assets Expiring Soon (â‰¤ 30 days)
    </h2>

    <!-- Dynamic list populated via Firestore -->
    <div id="adminExpireList" class="space-y-3 text-sm">
      <p class="text-white/50">Loadingâ€¦</p>
    </div>
  </div>

  <!-- RIGHT: TABLE (structure handled in JS logic) -->

</div>
</main>

<!-- ===================== PAGE LOGIC ===================== -->
<script>
/**
 * Authentication & authorization check
 * Ensures:
 * - User is logged in
 * - User has admin role
 */
auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="login.html";

  const doc = await db.collection("users").doc(user.uid).get();
  if(!doc.exists || doc.data().role!=="admin"){
    alert("Admins only");
    return location.href="login.html";
  }

  loadStats();
  loadAdminExpiryNotifications();
});

/**
 * Loads dashboard statistics:
 * - Total approved assets
 * - Expired assets
 * - Assets expiring within 30 days
 */
async function loadStats(){
  const snap = await db.collection("assets")
    .where("status","==","approved")
    .get();

  let total=0, expired=0, soon=0;
  const today=new Date();

  snap.forEach(d=>{
    total++;
    const diff=Math.ceil(
      (new Date(d.data().expiryDate)-today)/86400000
    );

    if(diff<=0) expired++;
    else if(diff<=30) soon++;
  });

  totalAssets.textContent=total;
  expiredAssets.textContent=expired;
  expiringAssets.textContent=soon;
}

/**
 * Loads assets that are expiring within 30 days
 * Displays:
 * - Compact list (left)
 * - Table rows (prepared for detailed view)
 */
async function loadAdminExpiryNotifications(){
  const today=new Date();
  const snap=await db.collection("assets")
    .where("status","==","approved")
    .get();

  let listHTML="", tableHTML="", count=0;

  snap.forEach(doc=>{
    const a=doc.data();
    const diff=Math.ceil(
      (new Date(a.expiryDate)-today)/86400000
    );

    if(diff>0 && diff<=30){
      count++;

      /* Left-side compact notification list */
      listHTML+=`
        <div class="flex justify-between border-b border-white/10 pb-2">
          <div class="break-words">
            <strong>${a.name}</strong>
            <span class="text-white/50">(${a.department})</span>
          </div>
          <span class="text-red-400 font-semibold">${diff} days</span>
        </div>
      `;

      /* Table row HTML prepared for extended view */
      tableHTML+=`
        <tr class="border-b border-white/5">
          <td class="px-4 py-3 font-medium break-words">${a.name}</td>
          <td class="px-4 py-3">${a.department}</td>
          <td class="px-4 py-3 text-right font-semibold text-red-400">
            ${diff}
          </td>
        </tr>
      `;
    }
  });

  /* Render list or fallback message */
  adminExpireList.innerHTML = count
    ? listHTML
    : `<p class="text-white/50">No assets expiring soon ðŸŽ‰</p>`;

  /* Render table rows (if table exists) */
  adminExpireTable.innerHTML = tableHTML ||
    `<tr>
      <td colspan="3" class="px-4 py-4 text-center text-white/50">
        No expiring assets
      </td>
    </tr>`;
}
</script>

</body>
</html>
